<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Condensed&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="main.css">

    <title>Document</title>
</head>

<body>
    <div id="app">
        <div class="sidebar">
            <p>{{patientInfo.lastName}}</p>
            <p>{{patientInfo.firstName}} {{patientInfo.middleName}}</p>
            <p>ID {{patientInfo.id}}</p>
            <p>{{patientInfo.gender}}, Age {{patientInfo.age}}</p>
            <div class="sidebar__line"></div>
            <p>Chief Complaint</p>
            <p>{{patient.MeditechEDM.ChiefComplaint}}</p>
            <p>Dietary Restrictions</p>
            <div v-for="restriction in patientDietaryRestrictions.slice(0,3)">
                <p>{{restriction.key}}</p>
                <p>{{restriction.value[0].ServiceDate}}</p>
            </div>
            <p>Current Medications</p>
            <p>Allergies</p>
            <div class="sidebar__line"></div>
            <p>Notes</p>
        </div>
        <div class="main">
            <category v-bind:type="0" v-bind:data="patientLaboratories"></category>
            <category v-bind:type="1"></category>
            <category v-bind:type="2"></category>

            <div></div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="fake_patient_data.js"></script>

    <script>
        Vue.component('lab-card', {
            template: '#lab-card-template',
            props: {
                data: Object,
                type: Number,
            },
            data() {
                return {
                    ordersToShow: 20,
                }
            },
            computed: {
            },
            methods: {

            },
        });
    </script>
    <template id="lab-card-template">
        <div class="lab-card">
            <p>{{data.key}}</p>
        </div>
    </template>

    <script>
        Vue.component('category', {
            template: '#category-template',
            props: {
                data: Array,
                type: Number,
            },
            data() {
                return {
                    ordersToShow: 20,
                }
            },
            computed: {
                title() {
                    let types = [
                        'Laboratories',
                        'Imaging',
                        'Others',
                    ]
                    return types[this.type];
                }
            },
            methods: {

            },
        });
    </script>
    <template id="category-template">
        <div class="category">
            <p>{{title}}</p>
            <div class="category__cards-con">
                <div class="category__scroll">
                    <template v-if="type === 0">
                        <lab-card v-for="item in data" v-bind:data="item"></lab-card>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <script>
        new Vue({
            el: '#app',
            data: {
                doctor: {
                    firstName: "Jorge",
                    middleName: "L.",
                    lastName: "Weaver",
                    type: "Physician",
                    id: "03578115",
                },
                patients: patients,
            },
            computed: {
                patient() {
                    return patients[0];
                },
                today() {
                    return moment("2031 02 20", "YYYY MM DD");
                },
                patientOrderHistory() {
                    return this.patient.OrderEntry.sort((a, b) => {
                        let dateA = this.momentParseDMY(a.ServiceDate).format('x');
                        let dateB = this.momentParseDMY(b.ServiceDate).format('x');
                        return (dateB - dateA);
                    });
                },
                patientInfo() {

                    let birthDate = this.momentParseDMY(this.patient.Info.Birthday);
                    let age = moment().diff(birthDate, 'years');

                    return {
                        firstName: this.patient.Info.FirstName,
                        middleName: this.patient.Info.MiddleName,
                        lastName: this.patient.Info.LastName,
                        id: this.patient.Info.ID,
                        gender: this.patient.Info.Gender,
                        age: age,
                    }
                },
                patientDietaryRestrictions() {
                    let filtered = this.patientOrderHistory.filter(d => d.Category === 'Dietary');

                    let combined = d3.nest()
                        .key(d => d.Procedure)
                        .rollup(d => d)
                        .entries(filtered);

                    let sorted = combined.sort((a, b) => {
                        let dateA = this.momentParseDMY(a.value[0].ServiceDate).format('x');
                        let dateB = this.momentParseDMY(b.value[0].ServiceDate).format('x');
                        return (dateB - dateA);
                    });

                    return sorted;
                },
                patientLaboratories() {
                    let filtered = this.patientOrderHistory.filter(d => d.Category === 'Laboratory');

                    let combined = d3.nest()
                        .key(d => d.Procedure)
                        .rollup(d => d)
                        .entries(filtered);

                    let sorted = combined.sort((a, b) => {
                        let dateA = this.momentParseDMY(a.value[0].ServiceDate).format('x');
                        let dateB = this.momentParseDMY(b.value[0].ServiceDate).format('x');
                        return (dateB - dateA);
                    });

                    return sorted;
                }
            },
            methods: {
                momentParseDMY(date) {
                    return moment(date, 'DD-MMMM-YYYY');
                },
            }
        })
    </script>
</body>

</html>